# Backend Package

Convex serverless backend with Better Auth authentication.

## Commands

```bash
cd packages/backend && npx convex dev       # Start dev with live sync
cd packages/backend && npx convex deploy    # Deploy to production
```

## Package Exports

Other packages import from `@with-stef/backend`:
```typescript
import { api } from "@with-stef/backend/convex/_generated/api"
import type { Doc, Id } from "@with-stef/backend/convex/_generated/dataModel"
import { createWebAuthClient } from "@with-stef/backend/auth-client"
```

## Directory Structure

```
convex/
├── schema.ts              # Database schema
├── functions.ts           # Auth-level custom query/mutation wrappers
├── trivia.ts              # Trivia game queries and mutations
├── auth.ts                # Better Auth component setup
├── auth.config.ts         # Auth configuration
├── http.ts                # HTTP router (Better Auth routes)
├── convex.config.ts       # App definition (registers Better Auth component)
├── betterAuth/
│   ├── schema.ts          # Auth tables (user, session, account, etc.)
│   └── _generated/        # Better Auth generated files (do not edit)
└── _generated/            # Convex generated files (do not edit)

src/
└── auth-client.ts         # Exported web auth client factory
```

## Auth Wrappers

Use these instead of raw `query`/`mutation` from `_generated/server`:

```typescript
// No auth required
import { publicQuery, publicMutation } from "./functions"

// Requires logged-in user — ctx.user is available
import { authedQuery, authedMutation } from "./functions"

// Requires admin role — ctx.user is available, role verified
import { adminQuery, adminMutation } from "./functions"
```

Built with `convex-helpers` `customQuery`/`customMutation`. The `ctx.user` object has: `_id`, `email`, `name`, `emailVerified`, `image`, `role` ("user" | "admin"), `createdAt`, `updatedAt`.

## Schema

Four domain tables: `triviaGames`, `triviaQuestions`, `triviaParticipants`, `triviaAnswers`.

Auth tables managed by the Better Auth component in `betterAuth/schema.ts`: `user`, `session`, `account`, `verification`, `jwks`.

### Conventions

- **Soft deletes**: Tables have `deletionTime: v.optional(v.number())`. Set to `Date.now()` to soft-delete. Always filter `deletionTime === undefined` in queries.
- **Cascading deletes**: Deleting a game soft-deletes its questions, participants, and answers.
- **User IDs are strings**: Better Auth user IDs cross the component boundary as strings, not Convex `Id` types. Fields like `createdBy` and `userId` use `v.string()`.
- **System fields**: `_id` and `_creationTime` are auto-generated by Convex. Don't define indices for `_id`.
- **Validators**: Use `v` from `convex/values` for all schema and argument definitions.

## Auth Setup

- **Provider**: Email/password
- **Roles**: `"user"` (default) and `"admin"` via `user.additionalFields`
- **CORS**: Allows `localhost:3000`, `localhost:3001`, and the production domains
- **Cookies**: `sameSite: "none"`, `secure: true` (required for cross-domain + mobile)

## Generated Files (do not edit)

- `convex/_generated/` - Convex codegen
- `convex/betterAuth/_generated/` - Better Auth component codegen
